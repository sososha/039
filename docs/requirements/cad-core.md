# CAD Core Requirements — Geometry / Topology / History

## 1️⃣ Scope & Purpose

- この文書は **建築CADコア** の要件を定義する。レンダリングコア(`rendering-core`)とは分離された層とする。
- 対象は建築分野（意匠・構造の骨組み・空間）であり、機械設計や設備(MEP)向けの機能は含めない。
- ここで言うCADコアとは:
  - 幾何(geometry)・トポロジ(topology)・履歴(history)・拘束(constraints)
  - 編集操作(operations)とバージョン管理
  を扱う **モデリングカーネル層** を指す。
- BIM 的な情報（用途・材料・性能などの属性）は「将来的に載せる拡張層」。現段階では、建築CADとしての幾何・トポロジ・履歴・基本属性の堅牢性を最優先する。

## 2️⃣ Design Philosophy

- **建築BIM志向**
  - グリッド、レベル(階)、壁・床・屋根・柱・梁・開口など「建築要素」を第一級オブジェクトとして扱い、MCADのパーツ/ギア/機構は扱わない。
- **BRep/CSG/Sketchはカーネルの責務**
  - 面/エッジ/頂点/ループなどのトポロジ構造はコアが保持し、レンダリング層に漏らさない。
- **f64 精度の世界観**
  - 内部座標は f64 を基本とし、レンダリング用 f32 への丸めは `KernelShape::tessellate` 側で制御する。
- **レンダリングから独立したモデリング**
  - 「表示できるかどうか」ではなく「正しい幾何・トポロジであるか」を最優先に設計する。

## 3️⃣ Data Model Requirements

- **BRep 構造**
  - Vertex: 3D point (f64)
  - Edge: 曲線 + 端点(Vertex) + パラメータ範囲
  - Face: パラメトリック面 + 外周/内周ループ
  - Shell/Solid: Face の集合
  - これらの位相関係(incidence)を失わないこと。

- **ID と参照**
  - トポロジ要素(Vertex/Edge/Face/Solid)には安定IDを持たせる。
  - `EntityId` との対応は「ビュー層の関心事」として別のマッピングで扱う。

- **履歴 / フィーチャー**
  - フィーチャーベース(押し出し/ブーリアン/フィレット等)で操作履歴を保持できる拡張余地を残す。
  - ただし初期段階では「履歴は optional」でよく、BRep を直接編集するモードも許容する。

- **Constraints/Dimensions**
  - スケッチ(2D)用の拘束・寸法は別サブシステムとして扱う。ここでは「拘束付きスケッチから BRep へ投影できる拡張性」を要件とするに留める。

## 4️⃣ Integration with Rendering Core

- **KernelShape 実装**
  - CADコアは各トポロジ(Edge/Face/Solid)に対して `impl KernelShape` を提供できること。
  - `tessellate(&TessParams) -> MeshData` は f64 幾何を入力に、f32 メッシュ/ポリラインを生成する。

- **選択とハイライト**
  - レンダリング層の EntityId から、元のトポロジID(例えば EdgeId/FaceId) へ逆マップできる仕組みを用意する。
  - 選択は「カーネルのトポロジ要素」を単位とし、レンダリングはそのビューである。

## 5️⃣ Non-Functional

- 精度: BRep 内部は double 精度。テッセレーション誤差は `TessParams` で制御し、指定誤差以下であること。
- 安定性: 幾何的矛盾(自己交差など)が発生した場合は、コアがエラーを返し、レンダリング層はそれをそのまま扱う。
- 拡張性: 後から別カーネル(OpenCascade等)を差し替えられるよう、レンダリングコアへの依存方向を一方向に保つ。

## 6️⃣ Out of Scope (for now)

- 完全な商用級カーネル機能(フィレット/ブレンドの全ケース対応など)
- マルチボディ・アセンブリ管理の詳細
- 永続化フォーマット(STEP/Parasolid等)の仕様
- 機械設計用機能(ギア/シャフト/ベアリング/機構解析など)
- 設備(MEP)専用の配管/ダクト/ケーブルトレイ専用モデリング機能
